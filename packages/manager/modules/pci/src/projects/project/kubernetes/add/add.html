<h1 data-translate="kubernetes_add"></h1>

<cui-message-container
    id="{{$ctrl.KUBE_CONTAINER_MESSAGES}}"
    data-messages="$ctrl.messages"
></cui-message-container>

<pci-activate-project-banner
    data-ng-if="$ctrl.isDiscoveryProject"
    data-on-click="$ctrl.goToDiscoveryProjectActivationPage()"
    data-tracking-page-name="PublicCloud::pci::projects::project::kubernetes::add"
></pci-activate-project-banner>

<form name="kubeAddClusterForm">
    <oui-stepper data-current-index="$ctrl.currentStep">
        <!--Select region-->
        <oui-step-form
            name="kubernetes_add_region"
            data-header="{{:: 'kubernetes_add_region_title' | translate }}"
            data-editable="!$ctrl.isAdding"
            data-navigation="$ctrl.cluster.region"
            data-on-focus="$ctrl.displaySelectedRegion = false"
            data-on-submit="$ctrl.onRegionSubmit()"
        >
            <pci-project-regions-list
                data-regions="$ctrl.regions"
                data-selected-region="$ctrl.cluster.region"
                data-display-selected-region="$ctrl.displaySelectedRegion"
            ></pci-project-regions-list>

            <!--Add new region banner info-->
            <oui-message
                type="info"
                data-ng-if="!$ctrl.displaySelectedRegion && $ctrl.cluster.region && !$ctrl.cluster.region.enabled"
            >
                <span data-translate="kubernetes_add_region_info"></span>
            </oui-message>
        </oui-step-form>

        <!--Select kube version-->
        <oui-step-form
            name="kubernetes_add_version"
            data-header="{{:: 'kubernetes_add_version_title' | translate }}"
            data-editable="!$ctrl.isAdding"
            data-valid="$ctrl.cluster.version"
            data-navigation="$ctrl.cluster.version"
            data-on-focus="$ctrl.onKubeVersionFocus()"
            data-on-submit="$ctrl.displaySelectedVersion = true"
            data-loading="$ctrl.isAddingNewRegion"
            data-loading-text="{{ 'kubernetes_add_region_inprogress' | translate: { name: $ctrl.cluster.region.name } }}"
        >
            <pci-project-versions-list
                data-ng-if="!$ctrl.isAddingNewRegion"
                data-versions="$ctrl.versions"
                data-selected-version="$ctrl.cluster.version"
                data-highest-version="$ctrl.highestVersion"
                data-display-selected-version="$ctrl.displaySelectedVersion"
            >
            </pci-project-versions-list>
        </oui-step-form>

        <!--Select private network -->
        <oui-step-form
            name="kubernetes_add_private_network"
            data-header="{{:: 'kubernetes_add_private_network' | translate }}"
            data-on-focus="$ctrl.displaySelectedPrivateNetwork = true"
            data-on-submit="$ctrl.displaySelectedPrivateNetwork = false"
            data-editable="!$ctrl.isAdding"
            data-valid="$ctrl.isValidNetworkConfig(kubeAddClusterForm['kubernetes_add_private_network'])"
            data-prevent-next="true"
        >
            <!--Select Public/Private network-->
            <h6 data-translate="kubernetes_add_private_network_label"></h6>
            <p>
                <span
                    data-translate="kubernetes_add_private_network_description"
                ></span>
                <a
                    data-ng-if="$ctrl.displaySelectedPrivateNetwork"
                    data-ng-href="{{:: $ctrl.addPrivateNetworksLink }}"
                    data-translate="kubernetes_add_private_network_add"
                    target="_top"
                ></a>
            </p>
            <oui-field>
                <oui-select
                    data-name="privateNetwork"
                    data-model="$ctrl.cluster.network.private"
                    data-items="$ctrl.availablePrivateNetworks"
                    data-match="name"
                    data-on-change="$ctrl.loadPrivateNetworkSubnets()"
                    data-searchable
                >
                </oui-select>
            </oui-field>

            <oui-spinner
                class="mb-3"
                data-size="s"
                data-ng-if="$ctrl.cluster.network.private.id && $ctrl.isLoadingPrivateNetworkSubnets"
            ></oui-spinner>

            <!--Select subnet-->
            <div data-ng-if="$ctrl.shouldShowSubnetForms">
                <h6 data-translate="kubernetes_add_private_network_subnet"></h6>
                <p>
                    <span
                        data-translate="kubernetes_add_private_network_subnet_description"
                    ></span>
                    <a
                        data-ng-href="{{:: $ctrl.addPrivateNetworksSubnetLink }}"
                        data-translate="kubernetes_add_private_network_subnet_link"
                        target="_top"
                    ></a>
                </p>
                <oui-field>
                    <oui-select
                        data-name="privateNetworkSubnet"
                        data-model="$ctrl.cluster.network.private.subnet"
                        data-items="$ctrl.privateNetworkSubnets"
                        data-match="id"
                        data-on-change="$ctrl.onPrivateNetworkSubnetChanged(modelValue)"
                    >
                        <span data-ng-bind="$item.id"></span> -
                        <span data-ng-bind="$item.cidr"></span>
                    </oui-select>
                </oui-field>
            </div>

            <oui-message
                data-ng-if="$ctrl.privateNetworkSubnetsError"
                data-type="{{ $ctrl.privateNetworkSubnetsError.type }}"
            >
                <span
                    data-ng-bind="$ctrl.privateNetworkSubnetsError.message"
                ></span>
            </oui-message>

            <!--Chose OVHcloud or vRack gateway-->
            <gateway-management-component
                data-ng-if="
                    $ctrl.cluster.network.private.id &&
                    !$ctrl.isLoadingPrivateNetworkSubnets
                "
                data-network="$ctrl.cluster.network"
                data-elevate-title="true"
            ></gateway-management-component>

            <!--Select load balancer subnet-->
            <div data-ng-if="$ctrl.shouldShowSubnetForms">
                <h6
                    class="d-flex align-items-center"
                    data-ng-click="$ctrl.toggleLoadBalancerSubnetForm()"
                >
                    <span
                        data-translate="kubernetes_add_private_network_lb_subnet_toggler"
                    ></span>
                    <span
                        class="kubernetes-add-private-network-lb-subnet-toggler oui-icon ml-2"
                        aria-hidden="true"
                        data-ng-class="{
                            'oui-icon-chevron-up': $ctrl.isLoadBalancerSubnetFormShown,
                            'oui-icon-chevron-down': !$ctrl.isLoadBalancerSubnetFormShown,
                        }"
                    ></span>
                </h6>
                <div data-ng-if="$ctrl.isLoadBalancerSubnetFormShown">
                    <p>
                        <span
                            data-translate="kubernetes_add_private_network_lb_subnet_description"
                        ></span>
                    </p>
                    <oui-field>
                        <oui-select
                            data-name="privateNetworkLbSubnet"
                            data-model="$ctrl.cluster.network.private.lbSubnet"
                            data-items="$ctrl.privateNetworkSubnets"
                            data-match="id"
                        >
                            <span data-ng-bind="$item.id"></span> -
                            <span data-ng-bind="$item.cidr"></span>
                        </oui-select>
                    </oui-field>
                </div>
            </div>
        </oui-step-form>

        <!--Select node pool configuration -->
        <oui-step-form
            data-header="{{:: 'kube_common_node_pool_title' | translate }}"
            data-editable="!$ctrl.isAdding"
            data-valid="$ctrl.cluster.nodePool.flavor"
            data-navigation="$ctrl.cluster.nodePool.flavor"
            data-on-focus="$ctrl.onNodePoolFocus()"
            data-on-submit="$ctrl.onNodePoolSubmit()"
            name="kubernetes_add_node_pool"
            data-loading="$ctrl.loadingFlavors"
        >
            <node-pool-configuration
                data-ng-if="$ctrl.displaySelectedRegion && !$ctrl.loadingFlavors"
                data-region="$ctrl.cluster.region"
                data-service-name="{{:: $ctrl.projectId }}"
                data-selected-flavor="$ctrl.cluster.nodePool.flavor"
                data-display-selected-flavor="$ctrl.displaySelectedFlavor"
                data-flavors="$ctrl.flavors"
            >
            </node-pool-configuration>
        </oui-step-form>

        <!--Autoscaling-->
        <oui-step-form
            data-header="{{:: 'kube_common_node_pool_autoscaling_title' | translate }}"
            data-editable="!$ctrl.isAdding"
            data-on-focus="$ctrl.displayNodePoolSizing = true"
            data-on-submit="$ctrl.displayNodePoolSizing = false"
            name="nodepool_add_configuration"
            data-loading="$ctrl.loadingFlavors"
            valid="$ctrl.cluster.nodePool.autoscaling.isValidScale"
            prevent-next
        >
            <node-pool-autoscaling
                data-is-edit-mode="false"
                data-node-pool="$ctrl.cluster.nodePool"
                data-display-node-pool-sizing="$ctrl.displayNodePoolSizing"
            >
            </node-pool-autoscaling>
        </oui-step-form>

        <!--Billing and anti-affinity-->
        <oui-step-form
            data-header="{{:: 'kubernetes_add_billing_anti_affinity_title' | translate }}"
            data-editable="!$ctrl.isAdding"
            data-valid="$ctrl.cluster.nodePool.flavor"
            data-navigation="$ctrl.cluster.nodePool.flavor"
            name="kubernetes_add_node_pool_billing_type"
        >
            <node-pool-anti-affinity
                data-node-pool="$ctrl.cluster.nodePool"
                anti-affinity-max-nodes="$ctrl.antiAffinityMaxNodes"
            >
            </node-pool-anti-affinity>

            <oui-message
                data-type="info"
                data-ng-if="$ctrl.IsComingSoonPricingBannerDisplayed()"
            >
                <h6
                    data-translate="kubernetes_add_billing_anti_affinity_coming_soon_message_title"
                ></h6>
                <p
                    data-translate="kubernetes_add_billing_anti_affinity_coming_soon_message_description"
                ></p>
            </oui-message>

            <p
                data-ng-if="!$ctrl.IsComingSoonPricingBannerDisplayed()"
                data-translate="kubernetes_add_billing_type_description"
            ></p>

            <pci-project-flavor-billing
                data-flavor="$ctrl.cluster.nodePool.flavor"
                data-number="$ctrl.cluster.nodePool.autoscaling.nodes.desired.value"
                data-monthly-billing="$ctrl.cluster.nodePool.monthlyBilling"
                data-disabled="false"
            >
            </pci-project-flavor-billing>
            <oui-message
                data-type="warning"
                data-ng-if="$ctrl.isBillingWarningMessageDisplayed()"
            >
                <p
                    data-translate="kubernetes_add_billing_auto_scaling_monthly_warning"
                ></p>
            </oui-message>
            <p data-translate="kubernetes_add_billing_type_payment_method"></p>
        </oui-step-form>

        <!--Choose the kube name-->
        <oui-step-form
            data-header="{{:: 'kubernetes_add_name_title' | translate }}"
            data-editable="!$ctrl.isAdding"
            data-valid="$ctrl.cluster.name && !$ctrl.isDiscoveryProject"
            data-navigation="$ctrl.cluster.name"
            data-on-submit="$ctrl.create()"
            name="kubernetes_add_name"
            data-prevent-next
        >
            <oui-field
                data-size="m"
                data-label="{{:: 'kubernetes_add_name' | translate }}"
                data-error-messages="{'pattern' : ('kubernetes_add_cluster_name_input_pattern_validation_error' | translate)}"
            >
                <input
                    class="oui-input"
                    type="text"
                    id="name"
                    name="name"
                    data-ng-model="$ctrl.cluster.name"
                    data-ng-maxlength="$ctrl.inputConstraints.MAX_LENGTH"
                    data-ng-pattern="$ctrl.inputConstraints.PATTERN"
                />
            </oui-field>

            <div data-ng-if="$ctrl.isAdding" class="d-flex align-items-center">
                <oui-spinner data-size="m"></oui-spinner>
                <span data-translate="kubernetes_add_loading"></span>
            </div>
        </oui-step-form>
    </oui-stepper>
</form>
