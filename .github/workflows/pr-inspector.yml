name: pr-inspector

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  push:

concurrency:
  group: pr-inspector-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  pr-inspector:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # -------------------------
      # Checkout (required for scripts + yarn.lock diff)
      # -------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------
      # 1) PR labeler (existing labels)
      # -------------------------
      - name: PR Labeler (actions/labeler)
        if: github.event_name == 'pull_request_target'
        uses: actions/labeler@v4
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Branch name labeler
        if: github.event_name == 'pull_request_target'
        uses: TimonVS/pr-labeler-action@v4
        with:
          configuration-path: .github/branch-name-labeler.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------
      # 2) Check regions metadata (log warning on PR)
      # -------------------------
      - name: Check regions metadata
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        run: ./scripts/regions/check-regions.sh
        shell: bash

      # -------------------------
      # 3) Merge conflict finder (log / detection)
      # -------------------------
      - name: Merge Conflict finder
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: olivernybroe/action-conflict-finder@v4.0
        with:
          exclude_dir: "node_modules/**"

      # -------------------------
      # 4) Auto-label merge conflicts => adds "has conflicts"
      # -------------------------
      - name: Auto-label merge conflicts
        if: github.event_name == 'pull_request'
        uses: mschilde/auto-label-merge-conflicts@master
        with:
          CONFLICT_LABEL_NAME: "has conflicts"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_RETRIES: 5
          WAIT_MS: 5000

      # -------------------------
      # 5) Yarn lock changes => comment summary
      # -------------------------
      - name: Yarn Lock Changes
        if: github.event_name == 'pull_request'
        uses: Simek/yarn-lock-changes@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          collapsibleThreshold: 10
          failOnDowngrade: false
          path: yarn.lock
          updateComment: true
