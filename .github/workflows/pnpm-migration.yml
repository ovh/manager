name: PNPM Migration

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  migrate-app:
    name: Migrate ${{ matrix.app }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        app: [
          "packages/manager/apps/pci-billing"
        ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install manager-pm only (isolated)
        run: yarn pm:isolated:install

      - name: Create migration branch
        run: |
          APP="${{ matrix.app }}"
          SCOPE="$(basename "$APP")"
          BRANCH="refactor/${SCOPE}-pnpm-migration"

          echo "APP=$APP" >> "$GITHUB_ENV"
          echo "SCOPE=$SCOPE" >> "$GITHUB_ENV"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          git checkout -b "$BRANCH"

      - name: Run PNPM migration
        run: |
          yarn pm:add:app --app "$APP"
          yarn install

      - name: Commit migration changes (OVH Manager format)
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add -A

          git commit -s \
            -m "refactor(${SCOPE}): migrate ${SCOPE} to pnpm" \
            -m "" \
            -m "ref: MANAGER-20363" \
            || echo "No changes to commit"

      - name: Push branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin "$BRANCH" --force-with-lease

      - name: Create draft PR with reviewer and label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "PNPM Migration: ${SCOPE}" \
            --body "Automated PNPM migration for app: \`${APP}\`" \
            --base develop \
            --head "$BRANCH" \
            --draft || true

          gh pr edit "$BRANCH" --add-label "pnpm-migration" || true
          gh pr edit "$BRANCH" --add-reviewer helabenkhalfallah || true
