name: PNPM Migration

on:
  workflow_dispatch:
    inputs:
      apps:
        description: 'JSON array of app paths (e.g. ["packages/manager/apps/pci-billing"])'
        required: true
        type: string
      ticket:
        description: 'JIRA ticket reference (e.g. MANAGER-20363)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  migrate-app:
    name: Migrate ${{ matrix.app }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(inputs.apps) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install manager-pm only (isolated)
        run: yarn pm:isolated:install

      - name: Create migration branch
        run: |
          set -euo pipefail

          APP="${{ matrix.app }}"
          SCOPE="$(basename "$APP")"
          TICKET="${{ inputs.ticket }}"
          BRANCH="refactor/${SCOPE}-pnpm-migration"

          echo "APP=$APP" >> "$GITHUB_ENV"
          echo "SCOPE=$SCOPE" >> "$GITHUB_ENV"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"
          echo "TICKET=$TICKET" >> "$GITHUB_ENV"

          git checkout -b "$BRANCH"

      - name: Run PNPM migration
        run: |
          set -euo pipefail
          yarn pm:add:app --app "$APP"
          yarn install

      - name: Commit migration changes (OVH Manager format)
        run: |
          set -euo pipefail

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add -A

          git commit -s \
            -m "refactor(${SCOPE}): migrate ${SCOPE} to pnpm" \
            -m "" \
            -m "ref: $TICKET" \
            || echo "No changes to commit"

      - name: Push branch
        run: |
          set -euo pipefail
          git push origin "$BRANCH" --force-with-lease

      - name: Create draft PR with reviewer and label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          gh pr create \
            --title "refactor(${SCOPE}): migrate ${SCOPE} to pnpm" \
            --body "Automated PNPM migration for app: \`${APP}\`\n\nref: #${TICKET}" \
            --base develop \
            --head "$BRANCH" \
            --draft || true

          gh pr edit "$BRANCH" --add-label "pnpm-migration" || true
          gh pr edit "$BRANCH" --add-reviewer helabenkhalfallah || true

      - name: Trigger checks (workflow_dispatch)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          dispatch () {
            local id="$1"
            local label="$2"
            echo "Dispatching: $label ($id) on ref=$BRANCH"
            gh workflow run "$id" --ref "$BRANCH" -R "$GITHUB_REPOSITORY" || true
          }

          dispatch 12916843  "Auto-label merge conflicts"
          dispatch 13241433  "Develop to master"
          dispatch 182921041  "Duplicate translation"
          dispatch 203809233  "Duplicate translation"
          dispatch 45402750  "Check package.json metadatas"
          dispatch 121811487 "Check Translations"
          dispatch 20485426  "Lint Commit Messages"
          dispatch 5919519   "Pull Request Labeler"
          dispatch 22085879  "Lint Code Base"
          dispatch 19905326  "Run tests"
          dispatch 10524442  "Merge Conflict Finder"
          dispatch 142750010 "Check for Release Branch"
          dispatch 13244149 "Yarn Lock Changes"

          # UXMAN required checks (build/install)
          dispatch 182017592 "recommended-checks-tests"

